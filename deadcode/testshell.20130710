#!/bin/bash

# Name of the job - You'll probably want to customize this.
#SBATCH -J sewx_driver

# Standard out and Standard Error output files with the job number in the name.
#SBATCH -o CAM-%j.output
#SBATCH -e CAM-%j.error

#SBATCH -n 1

################################################################

## 1 = Yellowstone, 2 = Flux, 3 = Agri

machineid=3

gridname=tcforecast_68_x4
numHoursSEStart=3

## Here we get two digit strings for UTC time for month, day, year
## We also get current time in hoursminutes (because the GFS output lags by 3.5 hours)
monthstr=`date -u +%m`
daystr=`date -u +%d`
yearstr=`date -u +%Y`
currtime=`date -u +%H%M`

## Use currtime to figure out what is the latest cycle we have access to
if [ $currtime -lt 0330 ]
then
  echo "18Z cycle"
  monthstr=`date --date="yesterday" -u +%m`
  daystr=`date --date="yesterday" -u +%d`
  yearstr=`date --date="yesterday" -u +%Y`
  cyclestr=18
elif [ $currtime -lt 0930 ]
then
  echo "00Z cycle"
  cyclestr=00
elif [ $currtime -lt 1530 ]
then
  echo "06Z cycle"
  cyclestr=06
elif [ $currtime -lt 2130 ]
then
  echo "12Z cycle"
  cyclestr=12
elif [ $currtime -ge 2130 ]
then
  echo "18Z cycle"
  cyclestr=18
else
  echo "Can't figure out start time"
#  exit
fi

## Figure out the seconds which correspond to the cycle and zero pad if neces
let cyclestrsec=$cyclestr*3600
while [ ${#cyclestrsec} -lt 5 ];
do
  cyclestrsec="0"$cyclestrsec
done

## Figure out what the SE start time will be after filter
if [ $numHoursSEStart -lt 6 ]
then
  let se_cyclestr=$cyclestr+03
  while [ ${#se_cyclestr} -lt 2 ];
  do
    se_cyclestr="0"$se_cyclestr
  done
  echo $se_cyclestr

  se_monthstr=$monthstr
  se_daystr=$daystr
  se_yearstr=$yearstr
  let se_cyclestrsec=$se_cyclestr*3600
  while [ ${#se_cyclestrsec} -lt 5 ];
  do
    se_cyclestrsec="0"$se_cyclestrsec
  done
else
  echo "SE forecast lead time too long, 18Z cycle causes trouble"
  echo "Not yet supported."
  exit 1
fi

## Use currtime to figure out what SST we can download
## Current GDAS SST appears 555 after cycle time
## First guess is today's dates!
sstmonthstr=$monthstr
sstdaystr=$daystr
sstyearstr=$yearstr
if [ $currtime -lt 0555 ]
then
  echo "SSTs are previous days 18Z"
  sstmonthstr=`date --date="yesterday" -u +%m`
  sstdaystr=`date --date="yesterday" -u +%d`
  sstyearstr=`date --date="yesterday" -u +%Y`
  sstcyclestr=18
elif [ $currtime -lt 1155 ]
then
  echo "SSTs are current days 00Z"
  sstcyclestr=00
elif [ $currtime -lt 1755 ]
then
  echo "SSTs are current days 06Z"
  sstcyclestr=06
elif [ $currtime -lt 2355 ]
then
  echo "SSTs are current days 12Z"
  sstcyclestr=12
elif [ $currtime -ge 2355 ]
then
  echo "SSTs are current days 18Z"
  sstcyclestr=18
else
  echo "Can't figure out start time"
  exit 1
fi

echo "The current time is $currtime"
echo "We are using $yearstr $monthstr $daystr $cyclestr Z ($cyclestrsec seconds) for GFS data"
echo "We are using $sstyearstr $sstmonthstr $sstdaystr $sstcyclestr Z for SST data"
echo "SE initialization will occur at $se_yearstr $se_monthstr $se_daystr $se_cyclestr Z ($se_cyclestrsec seconds)"

# Set input data type
# 1 = GFS forecast ICs
# 2 = ECMWF ERA40 reanalysis
inputdatatype=1

if [ $machineid -eq 1 ]
then
  echo "Using Yellowstone"
  backupdir=/glade/u/home/$LOGNAME/scriptbackups
  gfs_files_path=/glade/u/home/$LOGNAME/sewx/GFS
  gfs_to_cam_path=/glade/u/home/$LOGNAME/sewx/gfs_to_cam
  era_to_cam_path=/glade/home/zarzycki/obs_data_init/reanal_to_cam
  filter_path=/glade/u/home/$LOGNAME/sewx/filter
  path_to_se_build=/glade/u/home/$LOGNAME
  path_to_gz_touch=/glade/scratch/$LOGNAME/archive/$gridname/atm/logs
  path_to_nc_files=/glade/scratch/$LOGNAME/archive/$gridname/atm/hist
elif [ $machineid -eq 2 ]
then
  echo "Using UMich Flux"
  exit 1
elif [ $machineid -eq 3 ]
then
  echo "Using UCDavis Agri"
  backupdir=/home/$LOGNAME/scriptbackups
  gfs_files_path=/home/$LOGNAME/sewx/GFS
  gfs_to_cam_path=/home/$LOGNAME/sewx/gfs_to_cam
  era_to_cam_path=/home/$LOGNAME/sewx/reanal_to_cam
  filter_path=/home/$LOGNAME/sewx/filter
  path_to_se_build=/home/$LOGNAME
  path_to_gz_touch=$path_to_se_build/$gridname/run
  path_to_nc_files=$path_to_se_build/$gridname/run
else
  echo "Machine"
fi

# 30 -> CAM5 physics
# 26 -> CAM4 physics
numlevels=30

##set string=$month$day
##echo $string

# Set timestamp for backing up files, etc.
timestamp=`date +%Y%m%d.%H%M`
mkdir -p $backupdir

if [ $inputdatatype -eq 1 ]
then
    echo "Using GFS forecast ICs"
    echo "Getting GFS conditions"
    cd $gfs_files_path
    
    ## Pull atmospheric conditions
    ## Need to write an if call depending on how far back the GFS files are located
    ## The NCEP server only holds them for a few days -- otherwise go to nomads at NCDC
    # gfsFtpPath=http://nomads.ncdc.noaa.gov/data/gfsanl/$yearstr$monstr/$yearstr$monstr$daystr/
    # gfs.t12z.pgrb2f00.grb2
    echo "Getting Atmo file"
    rm gfs.t*pgrb2f00*
    gfsFTPPath=ftp://ftp.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/gfs.$yearstr$monthstr$daystr$cyclestr/
    gfsFTPFile='gfs.t'$cyclestr'z.pgrb2f00'
    ## Scrape for files
    error=1
    while [ $error != 0 ]
    do
      wget $gfsFTPPath$gfsFTPFile
      error=`echo $?`
      if [ $error -ne 0 ]
      then
        echo "Cannot get file, will wait 2 min and scrape again"
        sleep 120
      fi
    done
    mv $gfsFTPFile 'gfs_atm_'$yearstr$monthstr$daystr$cyclestr'.grib2'
    
    ## Pull sea surface temps, need to rename and delete (if necess)
    echo "Getting SST data"
    rm gdas1*sstgrb*
    sstFTPPath=ftp://ftp.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/gdas.$sstyearstr$sstmonthstr$sstdaystr/
    sstFTPFile='gdas1.t'$sstcyclestr'z.sstgrb.grib2'
    ## Scrape for files
    error=1
    while [ $error != 0 ]
    do
      wget $sstFTPPath$sstFTPFile
      error=`echo $?`
      if [ $error -ne 0 ]
      then
        echo "Cannot get file, will wait 2 min and scrape again"
        sleep 120
      fi
    done
    mv $sstFTPFile 'gfs_sst_'$yearstr$monthstr$daystr$cyclestr'.grib2'
    
    echo "Cding to GFS interpolation directory"
    cd $gfs_to_cam_path 
elif [$inputdatatype -eq 2 ]
then  
    echo "Using ECMWF forecast ICs"
    echo "Cding to ECMWF interpolation directory"
    cd $era_to_cam_path
else
    echo "Incorrect model IC entered"
    exit 1
fi

echo "Sedding commands in NCL interpolation scripts"
cp se_interp.ncl $backupdir/se_interp.BAK.$timestamp
sed 's?^numlevels.*?numlevels='$numlevels'?' se_interp.ncl > test.ncl
mv test.ncl se_interp.ncl
sed 's?^monthstr.*?monthstr="'$monthstr'"?' se_interp.ncl > test.ncl
mv test.ncl se_interp.ncl
sed 's?^yearstr.*?yearstr="'$yearstr'"?' se_interp.ncl > test.ncl
mv test.ncl se_interp.ncl
sed 's?^daystr.*?daystr="'$daystr'"?' se_interp.ncl > test.ncl
mv test.ncl se_interp.ncl
sed 's?^cyclestr.*?cyclestr="'$cyclestr'"?' se_interp.ncl > test.ncl
mv test.ncl se_interp.ncl

ncl se_interp.ncl machineid=$machineid 'gridname = "'$gridname'"' 'gfs_filename = "'$gfs_files_path'/gfs_atm_'$yearstr$monthstr$daystr$cyclestr'.grib2"'
ncl sst_interp.ncl 'sst_file_full = "'$gfs_files_path'/gfs_sst_'$yearstr$monthstr$daystr$cyclestr'.grib2"'

cd $path_to_se_build/$gridname

echo "Change date in FV namelist"
./xmlchange -file env_run.xml -id RUN_STARTDATE -val $yearstr-$monthstr-$daystr
./xmlchange -file env_run.xml -id START_TOD -val $cyclestrsec
./xmlchange -file env_run.xml -id STOP_OPTION -val nhours
./xmlchange -file env_run.xml -id STOP_N -val 6
cp user_nl_cam_filter user_nl_cam

## Get number of log files archived
numlogfiles=`ls $path_to_gz_touch/*.gz | wc -l`

echo $numlogfiles

echo "Begin call to filter-run"
if [ $machineid -eq 1 ]
then
  bsub < $gridname.run
elif [ $machineid -eq 2 ]
then
  echo "Using UMich Flux"
  exit 1
elif [ $machineid -eq 3 ]
then
  sbatch $gridname.run
  echo "Skip me"
else
  echo "Unsupported start time"
fi

## Hold script while log files from filter run haven't been archived yet
while [ `ls $path_to_gz_touch/*.gz | wc -l` == $numlogfiles ]
do
  sleep 20
  echo "Sleeping"
done
echo "Run over done sleeping will hold for 60 more sec to make sure files moved"

sleep 60

## Run NCL filter
cd $filter_path
filtfile_name=$gridname.cam.h0.$yearstr-$monthstr-$daystr-$cyclestrsec.nc
ncl digifilter.ncl machineid=$machineid 'filtfile_name = "'$filtfile_name'"' 'gridname = "'$gridname'"'

echo "Removing filter files"
mkdir -p $path_to_nc_files/filtered
mv $path_to_nc_files/*.nc $path_to_nc_files/filtered

echo "Make changes in CESM-SE namelist"
cd $path_to_se_build/$gridname
./xmlchange -file env_run.xml -id RUN_STARTDATE -val $se_yearstr-$se_monthstr-$se_daystr
./xmlchange -file env_run.xml -id START_TOD -val $se_cyclestrsec
./xmlchange -file env_run.xml -id STOP_OPTION -val ndays
./xmlchange -file env_run.xml -id STOP_N -val 10
cp user_nl_cam_run user_nl_cam

echo "Begin call to forecast run"
if [ $machineid -eq 1 ]
then
  bsub < $gridname.run
elif [ $machineid -eq 2 ]
then
  echo "Using UMich Flux"
  exit 1
elif [ $machineid -eq 3 ]
then
  sbatch $gridname.run
else
  echo "Unsupported start time"
fi

exit 0
