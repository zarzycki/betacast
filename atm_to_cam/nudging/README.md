# Nudging to ERA5 on Cheyenne

To nudge to hourly ERA5 data with either FV or SE (or any SE-like unstructured grid, like FV3) we can use the RDA dataset already mounted to Cheyenne in conjunction with the [Betacast](www.colinzarzycki.com) code.

- Generate ERA5 -> CAM grid map file
- Run batch script looping over atm_to_cam.ncl to generate nudging forcing files

### Generate ERA5 to map file

Betacast's (cloned to `${BETACAST}`) atm_to_cam requires an ESMF mapping file to regrid data from a host analysis grid to the CAM model grid. The easiest way to generate these is by using SCRIP grid files and NCL, Python, or the ESMF binaries.

Existing SCRIP files for ERA5 and CFSR (0.5) are in: `${BETACAST}/remapping/anl_scrip`

New host scrip files can be generated using `${BETACAST}/remapping/gen_reglatlon_SCRIP.ncl`

For CAM, supported SCRIP files can be dug up in the CESM data repo. The places I generally look for already processed SCRIP files are in:

- `/glade/p/cesmdata/inputdata/atm/cam/coords/`
- `/glade/p/cesmdata/inputdata/lnd/clm2/mappingdata/grids/`

After this, you can edit `${BETACAST}/remapping/gen_GFS_to_CAM_weight_file.ncl` to generate a weight file (ex: map_HOST_to_CAM_patc.nc.

### Run shell script

After generating a map file, you can run `${BETACAST}/atm_to_cam/nudging/gen-nudge.sh` script on Cheyenne's high memory nodes (see preamble). This job uses GNU parallel to spawn 36 jobs in parallel to use atm_to_cam to take data from the native ERA5 repo and create "nudging" (i.e., initial condition) files at each hourly time (e.g., 00Z, 01Z, etc.).

The only files that need to be set are `BNDTOPO` (CAM model topography for that grid) and `WGTNAME` (reanalysis to CAM weight file generated in the previous step).

NOTE: The default setting of `compress_file=True` in atm_to_cam uses NetCDF compression on the nudging files. This works fine on CESM2 nudging files but these files *cannot* be used for `ncdata` (initial conditions). If you want to use a file generated by atm_to_cam for initial conditions, you must set `compress_file=False`.
