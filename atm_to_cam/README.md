# atm_to_cam

This tool takes a 3-D analysis field from supported reanalysis products (CFSR, ERA5, ERAI), NWP analyses (GFS, RAP), or CAM/EAM full states and maps the data correctly onto a target grid for use in initialization (or nudging) of CAM or EAM.

## General workflow

1. Generate a `wgt_filename` (see below) to provide information regarding how to map the analysis grid to the target (model) grid.
2. (Optional) If using an unsupported vertical grid, add new level template file.
3. (Optional) Pre-stage data if not on Cheyenne.
4. Set up command line options for atm_to_cam.ncl
5. Using the below examples as a template, run `atm_to_cam.ncl`.

### Command line options for atm_to_cam.ncl

| Namelist Variable | Type | Description | Default | Required? |
| --- | --- | --- | --- | --- |
| datasource | Str | CFSR, ERA5, ERAI, GFS, CAM, RAP | | Y |
| numlevels | Int | Number of vertical levels | | Y |
| YYYYMMDDHH | Int | Initialization date in YYYYMMDDHH format | | Y |
| dycore | Str | fv, se, mpas | se | N |
| RDADIR | Str | Base path to RDA folder | "" | N |
| data_filename | Str | Full path to file containing initial information | | Y |
| wgt_filename | Str | Full path to ESMF weight file from ANL -> MOD | | Y |
| mpas_as_cam | Bool | If true, write MPAS in CAM physics output (ncol, for nudging), if false write MPAS in MPAS-A format (nCells, for init) | false | N |
| compress_file | Bool | If true, will attempt NetCDF "chunking" compression within NCL | false | N |
| write_floats | Bool | If true, write outputs as single instead of double precision | false | N |
| add_cloud_vars | Bool | If true, add CLDICE and CLDLIQ to output file | true | N |
| adjust_config | String | String defining how to perform hydro adjustment: if string is not empty, will do config. If "a" also try and correct TBOT in addition to PS | "" | N |
| model_topo_file | String | If MPAS, an MPAS inic file, otherwise a file containing PHIS for FV or SE | "" | N |
| se_inic | String | Full path of file to write as output | | Y |
| mod_in_topo | Str | Full path to PHIS field from *downscaling* MOD for pressure surface calculation purposes | "" | N |
| mod_remap_file | Str | Full path to ESMF weight file that goes *downscaling* MOD -> ANL | "" | N |

## Examples

#### Regridding ERA5 Cheyenne RDA --> SE ne30

```
ncl -n atm_to_cam.ncl 'datasource="ERA5RDA"' \
  numlevels=32 \
  YYYYMMDDHH=2019120100 \
  'dycore="se"' \
  'data_filename = "/glade/collections/rda/data//ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_129_z.ll025sc.1979010100_1979010100.nc"' \
  'wgt_filename="/glade/u/home/$LOGNAME/betacast/remapping/map_gfs_0.25x0.25_TO_ne30_patc.nc"' \
  'RDADIR="/glade/collections/rda/data/ds633.0/"' \
  'model_topo_file="/glade/p/cesmdata/cseg/inputdata/atm/cam/topo/se/ne30np4_nc3000_Co060_Fi001_PF_nullRR_Nsw042_20171020.nc"' \
  'adjust_config=""' \
  compress_file=False \
  write_floats=True \
  add_cloud_vars=True \
  'se_inic = "/glade/scratch/$LOGNAME/my_se_initial_condition_file.nc"'
```

### Some notes:

#### Generating a weight file

`wgt_filename` contains an ESMF file that provides mapping weights to go from the analysis grid to the model grid. An example would be to go from ERA5 0.25x0.25deg to CAM-SE ne30np4.

This file can be generated by using the NCL regridding scripts inside `${BETACAST}/remapping/gen_analysis_to_model_wgt_file.ncl`. Here, you must have a SCRIP grid descriptor for your target mesh. A series of included grids are found in `${BETACAST}/remapping/anl_scrip` for common analyses.

#### Downscaling CAM data

For downscaling CAM data one must pass in:

- mod_in_topo
- mod_remap_file

`mod_remap_file` should be an ESMF file going from the CAM input data to the analysis grid of interest (unless the forcing data is high-res, using the ERA5 0.25deg grid seems to be safest -- e.g., ne120 -> 0.25x0.25). `mod_in_topo` should be the path to the bnd_topo file containing PHIS for the downscaling model grid (e.g., ne120).

`data_filename` must contain a snapshot of 3-D U, V, T, Q, and 2-D PS. The requested `YYYYMMDDHH` must lie within the bounds of the time dimension in `data_filename`.

#### MPAS data

For MPAS data, the input variable `model_topo_file` actually contains the full initial condition file generated by MPAS's `init_atmosphere` routine. If one sets `mpas_as_cam` to False, `model_topo_file` will be copied to `se_inic` and then the state fields overwritten by the script so that the `se_inic` file can be passed in as an `ncdata` file.

#### Hydrostatic adjustment

Currently the hydrostatic adjustment is only available when `dycore` is set to SE. The code is activated if a valid `model_topo_file` containing `PHIS` is passed in and `adjust_config` is not an empty string. If `adjust_config=a` that applies a special case where both PS and TBOT are adjusted. Otherwise, only PS is adjusted. All state fields are then reinterpolated based on the new hybrid pressure levels associated with the updated PS.

#### Using RDA data

On Cheyenne (and when mirrored on other systems) Betacast can go directly to RDA to get ERA5 data. To do this, point `RDADIR` to the datasets top-level directory (e.g., /glade/collections/rda/data/ds633.0/). In this case, this file will be used if the hydrostatic adjustment code is active where `data_filename` is the invariant field containing the surface Z field (e.g., ${RDADIR}/e5.oper.invariant/197901/e5.oper.invariant.128_129_z.ll025sc.1979010100_1979010100.nc).
